import { Hono } from 'hono'
import { cors } from 'hono/cors'
import { serveStatic } from 'hono/cloudflare-workers'
import { streamSSE } from 'hono/streaming'

const app = new Hono()

// Enable CORS for frontend-backend communication
app.use('/api/*', cors())

// Serve static files from public directory  
app.use('/static/*', serveStatic({ root: './public' }))

// In-memory data store (for demo purposes)
let systemState = {
  nodes: {
    'dashboard': { id: 'dashboard', name: 'ëŒ€ì‹œë³´ë“œ', type: 'web', status: 'GREEN', x: 100, y: 100 },
    'api': { id: 'api', name: 'API ì„œë²„', type: 'api', status: 'GREEN', x: 300, y: 100 },
    'etl': { id: 'etl', name: 'ETL ì²˜ë¦¬', type: 'etl', status: 'GREEN', x: 500, y: 100 },
    'dwh': { id: 'dwh', name: 'DWH/HANA', type: 'database', status: 'GREEN', x: 700, y: 100 },
    'batch': { id: 'batch', name: 'ë°°ì¹˜ ì²˜ë¦¬', type: 'batch', status: 'GREEN', x: 300, y: 300 },
    'cache': { id: 'cache', name: 'ìºì‹œ', type: 'cache', status: 'GREEN', x: 500, y: 300 },
    'storage': { id: 'storage', name: 'ìŠ¤í† ë¦¬ì§€', type: 'storage', status: 'GREEN', x: 700, y: 300 }
  },
  edges: [
    { from: 'dashboard', to: 'api' },
    { from: 'api', to: 'etl' },
    { from: 'etl', to: 'dwh' },
    { from: 'api', to: 'cache' },
    { from: 'batch', to: 'dwh' },
    { from: 'cache', to: 'storage' }
  ],
  metrics: {},
  incidents: [],
  scenarioActive: null
}

// Initialize metrics
for (const nodeId in systemState.nodes) {
  systemState.metrics[nodeId] = {
    cpu: Math.random() * 30 + 10,
    memory: Math.random() * 40 + 20,
    response_time: Math.random() * 100 + 50,
    queue_depth: Math.random() * 10,
    error_rate: Math.random() * 2
  }
}

// API Routes
app.get('/api/topology', (c) => {
  return c.json({
    nodes: Object.values(systemState.nodes),
    edges: systemState.edges
  })
})

app.get('/api/status', (c) => {
  const status = {}
  for (const [nodeId, node] of Object.entries(systemState.nodes)) {
    status[nodeId] = {
      health: node.status,
      metrics: systemState.metrics[nodeId],
      summary: getNodeSummary(nodeId, node.status)
    }
  }
  return c.json(status)
})

app.get('/api/node/:id/drilldown', (c) => {
  const nodeId = c.req.param('id')
  const node = systemState.nodes[nodeId]
  
  if (!node) {
    return c.json({ error: 'Node not found' }, 404)
  }

  return c.json({
    node: node,
    metrics: systemState.metrics[nodeId],
    logs: getRecentLogs(nodeId),
    rootCause: getRootCause(nodeId, node.status),
    suggestions: getSuggestions(nodeId, systemState.scenarioActive)
  })
})

// Scenario Management
app.post('/api/scenario/start', async (c) => {
  const { s } = c.req.query()
  const scenario = parseInt(s || '1')
  
  systemState.scenarioActive = scenario
  
  if (scenario === 1) {
    // S1: ëŒ€ëŸ‰ ë™ì‹œ ì¡°íšŒ ì‹œë‚˜ë¦¬ì˜¤
    systemState.nodes.dwh.status = 'RED'
    systemState.nodes.etl.status = 'YELLOW'
    systemState.metrics.dwh.queue_depth = 150
    systemState.metrics.dwh.response_time = 8000
    systemState.metrics.dwh.cpu = 95
    
    systemState.incidents.push({
      id: Date.now().toString(),
      title: 'ê²°ì‚° ì‹œì  ëŒ€ëŸ‰ ì¡°íšŒ ê°ì§€ - ì§€ì—° ìœ„í—˜',
      nodeId: 'dwh',
      severity: 'HIGH',
      createdAt: new Date().toISOString(),
      status: 'ACTIVE'
    })
  } else if (scenario === 2) {
    // S2: ë§ˆìŠ¤í„° ë¶ˆì¼ì¹˜ ì‹œë‚˜ë¦¬ì˜¤  
    systemState.nodes.dwh.status = 'RED'
    systemState.nodes.batch.status = 'RED'
    systemState.metrics.dwh.response_time = 12000
    systemState.metrics.batch.error_rate = 25
    
    systemState.incidents.push({
      id: Date.now().toString(),
      title: 'ë§ˆìŠ¤í„° í”ŒëœíŠ¸ ì½”ë“œ ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ì¡°ì¸ í­ë°œ',
      nodeId: 'dwh',
      severity: 'CRITICAL',
      createdAt: new Date().toISOString(),
      status: 'ACTIVE'
    })
  }
  
  return c.json({ success: true, scenario, message: `ì‹œë‚˜ë¦¬ì˜¤ ${scenario} ì‹œì‘ë¨` })
})

app.post('/api/scenario/stop', (c) => {
  // Reset all nodes to GREEN
  for (const nodeId in systemState.nodes) {
    systemState.nodes[nodeId].status = 'GREEN'
  }
  
  // Reset metrics to normal values
  for (const nodeId in systemState.metrics) {
    systemState.metrics[nodeId] = {
      cpu: Math.random() * 30 + 10,
      memory: Math.random() * 40 + 20,
      response_time: Math.random() * 100 + 50,
      queue_depth: Math.random() * 10,
      error_rate: Math.random() * 2
    }
  }
  
  // Clear incidents
  systemState.incidents = []
  systemState.scenarioActive = null
  
  return c.json({ success: true, message: 'ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ ì •ì§€ë¨' })
})

// Remediation Actions
app.post('/api/remediation/apply', async (c) => {
  const { actionId, nodeId } = await c.req.json()
  
  let result = { success: false, message: '' }
  
  if (actionId === 'ENABLE_QUERY_GOVERNOR') {
    // S1 ìˆ˜ì • ì•¡ì…˜
    systemState.nodes.dwh.status = 'GREEN'
    systemState.nodes.etl.status = 'GREEN'
    systemState.metrics.dwh.queue_depth = 5
    systemState.metrics.dwh.response_time = 200
    systemState.metrics.dwh.cpu = 25
    
    result = { success: true, message: 'ì¿¼ë¦¬ ê±°ë²„ë„ˆ í™œì„±í™” ì™„ë£Œ' }
  } else if (actionId === 'SYNC_MASTER_DATA') {
    // S2 ìˆ˜ì • ì•¡ì…˜
    systemState.nodes.dwh.status = 'GREEN'
    systemState.nodes.batch.status = 'GREEN'
    systemState.metrics.dwh.response_time = 180
    systemState.metrics.batch.error_rate = 0.5
    
    result = { success: true, message: 'ë§ˆìŠ¤í„° ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ' }
  }
  
  // Mark incidents as resolved
  systemState.incidents.forEach(incident => {
    if (incident.status === 'ACTIVE') {
      incident.status = 'RESOLVED'
      incident.resolvedAt = new Date().toISOString()
    }
  })
  
  return c.json(result)
})

// Get active incidents
app.get('/api/incidents', (c) => {
  return c.json(systemState.incidents.filter(i => i.status === 'ACTIVE'))
})

// SSE endpoint for real-time updates
app.get('/api/events', (c) => {
  return streamSSE(c, async (stream) => {
    let id = 0
    
    const sendUpdate = () => {
      stream.writeSSE({
        data: JSON.stringify({
          status: systemState.nodes,
          metrics: systemState.metrics,
          incidents: systemState.incidents.filter(i => i.status === 'ACTIVE')
        }),
        event: 'update',
        id: String(id++)
      })
    }
    
    // Send initial state
    sendUpdate()
    
    // Send updates every 2 seconds
    const interval = setInterval(sendUpdate, 2000)
    
    // Clean up on client disconnect
    stream.onAbort(() => {
      clearInterval(interval)
    })
  })
})

// Helper functions
function getNodeSummary(nodeId: string, status: string): string {
  if (status === 'GREEN') return 'ì •ìƒ ìš´ì˜ì¤‘'
  if (systemState.scenarioActive === 1 && nodeId === 'dwh') {
    return 'ëŒ€ëŸ‰ ì¡°íšŒë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜'
  }
  if (systemState.scenarioActive === 2 && nodeId === 'dwh') {
    return 'ë§ˆìŠ¤í„° ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ì¡°ì¸ í­ë°œ'
  }
  return 'ìƒíƒœ í™•ì¸ í•„ìš”'
}

function getRecentLogs(nodeId: string): string[] {
  if (systemState.scenarioActive === 1 && nodeId === 'dwh') {
    return [
      '[ERROR] Queue depth exceeded threshold: 150/100',
      '[WARN] Query execution time: 8.2s (SLO: 2s)',
      '[INFO] Active sessions: 45 (normal: 15)',
      '[ERROR] Memory pressure detected: 95% usage'
    ]
  }
  if (systemState.scenarioActive === 2 && nodeId === 'dwh') {
    return [
      '[ERROR] Cartesian product detected in query plan',
      '[ERROR] Missing join condition: PLANT_CODE IS NULL',
      '[WARN] Query cardinality estimate: 1.2B rows',
      '[ERROR] Query timeout after 12 seconds'
    ]
  }
  return ['[INFO] ì •ìƒ ìš´ì˜ì¤‘', '[INFO] ë§ˆì§€ë§‰ ì²´í¬: ' + new Date().toLocaleTimeString()]
}

function getRootCause(nodeId: string, status: string): string {
  if (status === 'GREEN') return 'ì •ìƒ ìƒíƒœ'
  if (systemState.scenarioActive === 1 && nodeId === 'dwh') {
    return 'ê²°ì‚° ì‹œì  ëŒ€ëŸ‰ ë™ì‹œ ì¡°íšŒë¡œ ì¸í•œ í í¬í™” ìƒíƒœ'
  }
  if (systemState.scenarioActive === 2 && nodeId === 'dwh') {
    return 'ë§ˆìŠ¤í„° í”ŒëœíŠ¸ ì½”ë“œ ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ì¡°ì¸ í­ë°œ'
  }
  return 'ì›ì¸ ë¶„ì„ ì¤‘'
}

function getSuggestions(nodeId: string, scenario: number | null): Array<{id: string, label: string, description: string}> {
  if (scenario === 1 && nodeId === 'dwh') {
    return [
      {
        id: 'ENABLE_QUERY_GOVERNOR',
        label: 'ì¿¼ë¦¬ ê±°ë²„ë„ˆ í™œì„±í™”',
        description: 'í•„í„° ë¯¸ì„ íƒ ì°¨ë‹¨ ë° ê¸°ê°„ ìƒí•œ ì ìš©'
      },
      {
        id: 'APPLY_RATE_LIMIT',
        label: 'ë™ì‹œì„± ìƒí•œ ì ìš©',
        description: 'ì‚¬ìš©ìë³„ ìµœëŒ€ ë™ì‹œ ì‹¤í–‰ ì œí•œ'
      }
    ]
  }
  if (scenario === 2 && nodeId === 'dwh') {
    return [
      {
        id: 'SYNC_MASTER_DATA',
        label: 'ë§ˆìŠ¤í„° ì‹±í¬ ì‹¤í–‰',
        description: 'ì‹ ê·œ í”ŒëœíŠ¸ ì½”ë“œ ì¼ê´„ ë°˜ì˜'
      },
      {
        id: 'FIX_JOIN_QUERY',
        label: 'ì•ˆì „ì¡°ì¸ í…œí”Œë¦¿ ì ìš©',
        description: 'INNER JOIN + NOT NULL ê²€ì¦'
      }
    ]
  }
  return []
}

// Route: Page 1 - Normal Operations Demo
app.get('/', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì‹œìŠ¤í…œ ìš´ì˜ í˜„í™© - ì •ìƒ ê°€ë™ì¤‘</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          .status-card {
            transition: all 0.3s;
          }
          .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          }
          .pulse-green {
            animation: pulse-green 2s infinite;
          }
          @keyframes pulse-green {
            0%, 100% { background-color: #10b981; }
            50% { background-color: #059669; }
          }
        </style>
    </head>
    <body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
        <div class="max-w-7xl mx-auto p-6">
            <!-- Header -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-chart-line text-green-600 mr-3"></i>
                            ERP ì‹œìŠ¤í…œ ìš´ì˜ í˜„í™©
                        </h1>
                        <p class="text-gray-600">ëª¨ë“  ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ìš´ì˜ë˜ê³  ìˆìŠµë‹ˆë‹¤</p>
                    </div>
                    <div class="text-right">
                        <div class="bg-green-100 text-green-800 px-4 py-2 rounded-full font-semibold mb-2">
                            <i class="fas fa-check-circle mr-2"></i>
                            ì‹œìŠ¤í…œ ì •ìƒ
                        </div>
                        <p class="text-sm text-gray-500">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="current-time"></span></p>
                    </div>
                </div>
            </div>

            <!-- System Overview -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Overall Status -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-green-500 rounded-full pulse-green mr-3"></div>
                                <span class="font-medium">í•µì‹¬ ì„œë¹„ìŠ¤</span>
                            </div>
                            <span class="text-green-600 font-bold">100% ê°€ë™ì¤‘</span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-blue-500 rounded-full mr-3"></div>
                                <span class="font-medium">ì‘ë‹µ ì‹œê°„</span>
                            </div>
                            <span class="text-blue-600 font-bold">í‰ê·  120ms</span>
                        </div>
                        
                        <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg">
                            <div class="flex items-center">
                                <div class="w-4 h-4 bg-purple-500 rounded-full mr-3"></div>
                                <span class="font-medium">í™œì„± ì‚¬ìš©ì</span>
                            </div>
                            <span class="text-purple-600 font-bold">1,247ëª…</span>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">ì£¼ìš” ì§€í‘œ</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-gray-700">99.8%</div>
                            <div class="text-sm text-gray-500">ê°€ìš©ì„±</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-gray-700">2.1s</div>
                            <div class="text-sm text-gray-500">í‰ê·  ì²˜ë¦¬ì‹œê°„</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-gray-700">0.01%</div>
                            <div class="text-sm text-gray-500">ì˜¤ë¥˜ìœ¨</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-gray-700">98%</div>
                            <div class="text-sm text-gray-500">CPU íš¨ìœ¨ì„±</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Status Grid -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-xl font-semibold mb-6 text-gray-700">ì„œë¹„ìŠ¤ë³„ ìƒíƒœ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="status-card bg-green-50 border border-green-200 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-desktop text-green-600 text-xl"></i>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">ì •ìƒ</span>
                        </div>
                        <h3 class="font-semibold text-gray-700">ì‚¬ìš©ì í¬í„¸</h3>
                        <p class="text-sm text-gray-500">ì‘ë‹µì‹œê°„: 95ms</p>
                    </div>

                    <div class="status-card bg-green-50 border border-green-200 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-server text-green-600 text-xl"></i>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">ì •ìƒ</span>
                        </div>
                        <h3 class="font-semibold text-gray-700">API ê²Œì´íŠ¸ì›¨ì´</h3>
                        <p class="text-sm text-gray-500">ì²˜ë¦¬ëŸ‰: 850 req/s</p>
                    </div>

                    <div class="status-card bg-green-50 border border-green-200 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-database text-green-600 text-xl"></i>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">ì •ìƒ</span>
                        </div>
                        <h3 class="font-semibold text-gray-700">ë°ì´í„°ë² ì´ìŠ¤</h3>
                        <p class="text-sm text-gray-500">ì—°ê²°: 45/100</p>
                    </div>

                    <div class="status-card bg-green-50 border border-green-200 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-cogs text-green-600 text-xl"></i>
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">ì •ìƒ</span>
                        </div>
                        <h3 class="font-semibold text-gray-700">ë°°ì¹˜ ì²˜ë¦¬</h3>
                        <p class="text-sm text-gray-500">ëŒ€ê¸°: 2ê°œ ì‘ì—…</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Activity Log -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">ìµœê·¼ í™œë™</h2>
                    <div class="space-y-3">
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                            <div>
                                <p class="text-sm font-medium">ì •ê¸° ë°±ì—… ì™„ë£Œ</p>
                                <p class="text-xs text-gray-500">2ë¶„ ì „</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <i class="fas fa-check-circle text-green-500 mt-1"></i>
                            <div>
                                <p class="text-sm font-medium">ì‹œìŠ¤í…œ í—¬ìŠ¤ì²´í¬ í†µê³¼</p>
                                <p class="text-xs text-gray-500">5ë¶„ ì „</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <i class="fas fa-users text-purple-500 mt-1"></i>
                            <div>
                                <p class="text-sm font-medium">ì‹ ê·œ ì‚¬ìš©ì ë¡œê·¸ì¸: 23ëª…</p>
                                <p class="text-xs text-gray-500">10ë¶„ ì „</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">ì‹œìŠ¤í…œ ê´€ë¦¬</h2>
                    <div class="space-y-4">
                        <button onclick="location.href='/monitoring'" 
                                class="w-full bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-chart-bar mr-3"></i>
                            ìƒì„¸ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                        </button>
                        
                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                <span class="font-medium text-yellow-800">ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸</span>
                            </div>
                            <p class="text-sm text-yellow-700 mb-3">
                                ì‹œìŠ¤í…œ ì¥ì•  ëŒ€ì‘ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.
                            </p>
                            <button onclick="simulateIssue()" 
                                    class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 transition-colors text-sm">
                                ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Update current time
            function updateTime() {
                document.getElementById('current-time').textContent = new Date().toLocaleTimeString('ko-KR');
            }
            updateTime();
            setInterval(updateTime, 1000);

            // Simulate issue to go to monitoring page
            function simulateIssue() {
                if (confirm('ì¥ì•  ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì‹œìŠ¤í…œì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ë°œìƒí•œ ìƒí™©ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.')) {
                    // Start scenario and redirect
                    fetch('/api/scenario/start?s=1', { method: 'POST' })
                        .then(() => {
                            setTimeout(() => {
                                window.location.href = '/monitoring';
                            }, 1000);
                        });
                }
            }
        </script>
    </body>
    </html>
  `)
})

// Route: Page 2 - Governance & Architecture Monitoring  
app.get('/monitoring', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ëª¨ë‹ˆí„°ë§</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          .topology-container {
            width: 100%;
            height: 500px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            position: relative;
            background: linear-gradient(45deg, #f8fafc 25%, transparent 25%), 
                        linear-gradient(-45deg, #f8fafc 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #f8fafc 75%), 
                        linear-gradient(-45deg, transparent 75%, #f8fafc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
          }
          .node {
            position: absolute;
            width: 80px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          .node:hover {
            transform: scale(1.1);
            z-index: 10;
          }
          .node.GREEN { background: #10b981; color: white; }
          .node.YELLOW { background: #f59e0b; color: white; }
          .node.RED { background: #ef4444; color: white; }
          .edge {
            position: absolute;
            height: 2px;
            background: #6b7280;
            transform-origin: left center;
          }
          .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
          }
          .drilldown-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            transition: right 0.3s;
            z-index: 100;
          }
          .drilldown-panel.open {
            right: 0;
          }
          .approval-step {
            opacity: 0.5;
            transition: opacity 0.3s;
          }
          .approval-step.active {
            opacity: 1;
          }
          .approval-step.completed {
            opacity: 1;
            background: linear-gradient(135deg, #10b981, #059669);
          }
        </style>
    </head>
    <body class="bg-gray-50 p-4">
        <div class="max-w-7xl mx-auto">
            <!-- Header with Navigation -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <button onclick="location.href='/'" 
                                class="text-blue-600 hover:text-blue-800 mb-2">
                            <i class="fas fa-arrow-left mr-2"></i>
                            ë©”ì¸ ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                        </button>
                        <h1 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-sitemap mr-2 text-red-500"></i>
                            ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ëª¨ë‹ˆí„°ë§
                        </h1>
                        <p class="text-red-600 font-medium">âš ï¸ ì‹œìŠ¤í…œ ì´ìƒ ê°ì§€ë¨ - ìŠ¹ì¸ ì ˆì°¨ ì§„í–‰ ì¤‘</p>
                    </div>
                    <div class="text-right">
                        <div class="bg-red-100 text-red-800 px-4 py-2 rounded-full font-semibold mb-2">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            ê¸´ê¸‰ ëŒ€ì‘ ëª¨ë“œ
                        </div>
                        <button onclick="resetSystem()" 
                                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            <i class="fas fa-undo mr-2"></i>
                            ì‹œìŠ¤í…œ ë³µêµ¬
                        </button>
                    </div>
                </div>
            </div>

            <!-- Governance Approval Process -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-clipboard-check text-blue-600 mr-2"></i>
                    ê±°ë²„ë„ŒìŠ¤ ìŠ¹ì¸ ì ˆì°¨
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div id="step-1" class="approval-step completed bg-green-100 p-4 rounded-lg border border-green-300">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            <span class="font-semibold text-green-800">1ë‹¨ê³„ ì™„ë£Œ</span>
                        </div>
                        <p class="text-sm text-green-700">ì¥ì•  ê°ì§€ ë° ì•Œë¦¼</p>
                        <p class="text-xs text-green-600 mt-1">2ë¶„ ì „</p>
                    </div>

                    <div id="step-2" class="approval-step completed bg-green-100 p-4 rounded-lg border border-green-300">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            <span class="font-semibold text-green-800">2ë‹¨ê³„ ì™„ë£Œ</span>
                        </div>
                        <p class="text-sm text-green-700">ê´€ë¦¬ì ìŠ¹ì¸</p>
                        <p class="text-xs text-green-600 mt-1">1ë¶„ ì „</p>
                    </div>

                    <div id="step-3" class="approval-step active bg-blue-100 p-4 rounded-lg border border-blue-300">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-hourglass-half text-blue-600 mr-2"></i>
                            <span class="font-semibold text-blue-800">3ë‹¨ê³„ ì§„í–‰ì¤‘</span>
                        </div>
                        <p class="text-sm text-blue-700">ì•„í‚¤í…ì²˜ ë¶„ì„</p>
                        <div class="w-full bg-blue-200 rounded-full h-2 mt-2">
                            <div class="bg-blue-600 h-2 rounded-full w-3/4"></div>
                        </div>
                    </div>

                    <div id="step-4" class="approval-step bg-gray-100 p-4 rounded-lg border border-gray-300">
                        <div class="flex items-center mb-2">
                            <i class="fas fa-clock text-gray-500 mr-2"></i>
                            <span class="font-semibold text-gray-600">4ë‹¨ê³„ ëŒ€ê¸°ì¤‘</span>
                        </div>
                        <p class="text-sm text-gray-600">ìë™ ë³µêµ¬ ì‹¤í–‰</p>
                        <p class="text-xs text-gray-500 mt-1">ìŠ¹ì¸ í›„ ì§„í–‰</p>
                    </div>
                </div>
            </div>

            <!-- System Architecture Diagram -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold flex items-center">
                        <i class="fas fa-project-diagram text-purple-600 mr-2"></i>
                        ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ ì„¤ê³„ë„
                    </h2>
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        ë¹¨ê°„ ë…¸ë“œë¥¼ í´ë¦­í•˜ë©´ ìƒì„¸ ë¬¸ì œ ë¶„ì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    </div>
                </div>
                <div id="topology" class="topology-container">
                    <!-- Nodes and edges will be rendered here -->
                </div>
            </div>

            <!-- Real-time Metrics -->
            <div id="metrics-summary" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                <!-- Metrics cards will be rendered here -->
            </div>

            <!-- Problem Analysis Section -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-microscope text-red-600 mr-2"></i>
                    ì‹¤ì‹œê°„ ë¬¸ì œ ë¶„ì„
                </h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Current Issues -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">ğŸš¨ í˜„ì¬ ë°œìƒì¤‘ì¸ ë¬¸ì œ</h3>
                        <div id="current-issues" class="space-y-3">
                            <div class="bg-red-50 border border-red-200 p-4 rounded-lg">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <h4 class="font-semibold text-red-800">DWH ì„±ëŠ¥ ì €í•˜</h4>
                                        <p class="text-sm text-red-600 mt-1">í ê¹Šì´ ì´ˆê³¼ ë° ì‘ë‹µì‹œê°„ ì§€ì—°</p>
                                        <p class="text-xs text-red-500 mt-2">ì‹¬ê°ë„: ë†’ìŒ | ë°œìƒì‹œê°„: 3ë¶„ ì „</p>
                                    </div>
                                    <button onclick="showNodeDetails('dwh')" 
                                            class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                        ë¶„ì„
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommended Actions -->
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">ğŸ’¡ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­</h3>
                        <div class="space-y-3">
                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800">1. ì¿¼ë¦¬ ê±°ë²„ë„ˆ í™œì„±í™”</h4>
                                <p class="text-sm text-blue-600 mt-1">í•„í„° ë¯¸ì„ íƒ ì°¨ë‹¨ ë° ê¸°ê°„ ìƒí•œ ì ìš©</p>
                                <button onclick="applyRecommendation('ENABLE_QUERY_GOVERNOR')" 
                                        class="mt-2 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                    <i class="fas fa-play mr-1"></i>
                                    ì‹¤í–‰
                                </button>
                            </div>
                            
                            <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-800">2. ë™ì‹œì„± ì œí•œ ì ìš©</h4>
                                <p class="text-sm text-green-600 mt-1">ì‚¬ìš©ìë³„ ìµœëŒ€ ë™ì‹œ ì‹¤í–‰ ì œí•œ</p>
                                <button onclick="applyRecommendation('APPLY_RATE_LIMIT')" 
                                        class="mt-2 bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                    <i class="fas fa-play mr-1"></i>
                                    ì‹¤í–‰
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popup Modal for Node Details -->
        <div id="popup" class="popup hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md">
                <div class="flex items-center mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl mr-3"></i>
                    <h3 class="text-lg font-semibold">ë…¸ë“œ ìƒì„¸ ë¬¸ì œ ë¶„ì„</h3>
                </div>
                <div id="popup-content">
                    <!-- Content will be loaded here -->
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="closePopup()" 
                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                        ë‹«ê¸°
                    </button>
                    <button id="remediate-btn" onclick="remediate()" 
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-wrench mr-1"></i>
                        ìë™ ìˆ˜ë¦¬
                    </button>
                </div>
            </div>
        </div>

        <!-- Drilldown Panel -->
        <div id="drilldown-panel" class="drilldown-panel">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">ìƒì„¸ ë¡œê·¸ ë¶„ì„</h3>
                    <button onclick="closeDrilldown()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="drilldown-content">
                    <!-- Drilldown content will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Popup Overlay -->
        <div id="popup-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closePopup()"></div>

        <script>
            let currentIncident = null;
            let eventSource = null;

            // Initialize
            document.addEventListener('DOMContentLoaded', function() {
                loadTopology();
                loadStatus();
                startEventStream();
                
                // Auto-progress governance approval
                setTimeout(() => {
                    completeStep(3);
                    setTimeout(() => {
                        activateStep(4);
                    }, 2000);
                }, 3000);
            });

            function completeStep(step) {
                const stepEl = document.getElementById(\`step-\${step}\`);
                stepEl.className = 'approval-step completed bg-green-100 p-4 rounded-lg border border-green-300';
                stepEl.innerHTML = stepEl.innerHTML.replace('ì§„í–‰ì¤‘', 'ì™„ë£Œ').replace('hourglass-half', 'check-circle').replace('blue', 'green');
            }

            function activateStep(step) {
                const stepEl = document.getElementById(\`step-\${step}\`);
                stepEl.className = 'approval-step active bg-blue-100 p-4 rounded-lg border border-blue-300';
                stepEl.innerHTML = stepEl.innerHTML.replace('ëŒ€ê¸°ì¤‘', 'ì§„í–‰ì¤‘').replace('clock', 'hourglass-half').replace('gray', 'blue');
            }

            function startEventStream() {
                if (eventSource) {
                    eventSource.close();
                }
                
                eventSource = new EventSource('/api/events');
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateTopology(data.status);
                    updateMetrics(data.status, data.metrics);
                    updateCurrentIssues(data.incidents);
                };
            }

            async function loadTopology() {
                try {
                    const response = await fetch('/api/topology');
                    const data = await response.json();
                    renderTopology(data);
                } catch (error) {
                    console.error('Error loading topology:', error);
                }
            }

            async function loadStatus() {
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    updateMetrics(null, data);
                } catch (error) {
                    console.error('Error loading status:', error);
                }
            }

            function renderTopology(data) {
                const container = document.getElementById('topology');
                container.innerHTML = '';

                // Render edges first (so they appear behind nodes)
                data.edges.forEach(edge => {
                    const fromNode = data.nodes.find(n => n.id === edge.from);
                    const toNode = data.nodes.find(n => n.id === edge.to);
                    
                    if (fromNode && toNode) {
                        const edgeElement = document.createElement('div');
                        edgeElement.className = 'edge';
                        
                        const deltaX = toNode.x - fromNode.x;
                        const deltaY = toNode.y - fromNode.y;
                        const length = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                        const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
                        
                        edgeElement.style.width = length + 'px';
                        edgeElement.style.left = (fromNode.x + 40) + 'px';
                        edgeElement.style.top = (fromNode.y + 30) + 'px';
                        edgeElement.style.transform = \`rotate(\${angle}deg)\`;
                        
                        container.appendChild(edgeElement);
                    }
                });

                // Render nodes
                data.nodes.forEach(node => {
                    const nodeElement = document.createElement('div');
                    nodeElement.className = \`node \${node.status}\`;
                    nodeElement.style.left = node.x + 'px';
                    nodeElement.style.top = node.y + 'px';
                    nodeElement.onclick = () => showNodeDetails(node.id);
                    
                    nodeElement.innerHTML = \`
                        <i class="fas fa-server text-sm"></i>
                        <span class="text-xs font-semibold mt-1">\${node.name}</span>
                    \`;
                    
                    container.appendChild(nodeElement);
                });
            }

            function updateTopology(nodes) {
                const container = document.getElementById('topology');
                const nodeElements = container.querySelectorAll('.node');
                
                nodeElements.forEach((element, index) => {
                    const nodeId = Object.keys(nodes)[index];
                    if (nodeId && nodes[nodeId]) {
                        element.className = \`node \${nodes[nodeId].status}\`;
                    }
                });
            }

            function updateMetrics(nodes, data) {
                const container = document.getElementById('metrics-summary');
                container.innerHTML = '';

                Object.entries(data).forEach(([nodeId, info]) => {
                    const metrics = info.metrics || info;
                    const health = info.health || 'GREEN';
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow p-4 border-l-4 ' + 
                        (health === 'RED' ? 'border-red-500' : 
                         health === 'YELLOW' ? 'border-yellow-500' : 'border-green-500');
                    
                    card.innerHTML = \`
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-gray-700">\${nodeId.toUpperCase()}</h3>
                            <span class="px-2 py-1 rounded text-xs font-medium \${
                                health === 'GREEN' ? 'bg-green-100 text-green-800' :
                                health === 'YELLOW' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                            }">
                                \${health}
                            </span>
                        </div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>CPU:</span>
                                <span class="\${metrics.cpu > 80 ? 'text-red-600 font-bold' : ''}">\${Math.round(metrics.cpu)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ì‘ë‹µì‹œê°„:</span>
                                <span class="\${metrics.response_time > 5000 ? 'text-red-600 font-bold' : ''}">\${Math.round(metrics.response_time)}ms</span>
                            </div>
                            <div class="flex justify-between">
                                <span>í ê¹Šì´:</span>
                                <span class="\${metrics.queue_depth > 100 ? 'text-red-600 font-bold' : ''}">\${Math.round(metrics.queue_depth)}</span>
                            </div>
                            \${health === 'RED' ? '<button onclick="showNodeDetails(\\\'' + nodeId + '\\\\')" class="mt-2 w-full bg-red-600 text-white py-1 px-2 rounded text-xs hover:bg-red-700">ë¬¸ì œ ë¶„ì„</button>' : ''}
                        </div>
                    \`;
                    
                    container.appendChild(card);
                });
            }

            function updateCurrentIssues(incidents) {
                const container = document.getElementById('current-issues');
                if (!incidents || incidents.length === 0) return;

                container.innerHTML = '';
                incidents.forEach(incident => {
                    const issueElement = document.createElement('div');
                    issueElement.className = 'bg-red-50 border border-red-200 p-4 rounded-lg';
                    issueElement.innerHTML = \`
                        <div class="flex items-start justify-between">
                            <div>
                                <h4 class="font-semibold text-red-800">\${incident.title}</h4>
                                <p class="text-sm text-red-600 mt-1">ë…¸ë“œ: \${incident.nodeId.toUpperCase()}</p>
                                <p class="text-xs text-red-500 mt-2">ì‹¬ê°ë„: \${incident.severity} | ë°œìƒì‹œê°„: \${new Date(incident.createdAt).toLocaleTimeString()}</p>
                            </div>
                            <button onclick="showNodeDetails('\${incident.nodeId}')" 
                                    class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                ë¶„ì„
                            </button>
                        </div>
                    \`;
                    container.appendChild(issueElement);
                });
            }

            async function showNodeDetails(nodeId) {
                try {
                    const response = await fetch(\`/api/node/\${nodeId}/drilldown\`);
                    const data = await response.json();
                    
                    const content = document.getElementById('popup-content');
                    content.innerHTML = \`
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold text-red-700 mb-2">ğŸš¨ \${data.node.name} ë¬¸ì œ ìƒí™©</h4>
                                <p class="text-sm text-gray-700 bg-red-50 p-3 rounded">\${data.rootCause}</p>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold mb-2">ğŸ“Š í˜„ì¬ ì§€í‘œ</h4>
                                <div class="grid grid-cols-2 gap-2 text-sm bg-gray-50 p-3 rounded">
                                    <div class="flex justify-between">
                                        <span>CPU:</span>
                                        <span class="font-bold text-red-600">\${Math.round(data.metrics.cpu)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ì‘ë‹µì‹œê°„:</span>
                                        <span class="font-bold text-red-600">\${Math.round(data.metrics.response_time)}ms</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>í ê¹Šì´:</span>
                                        <span class="font-bold text-red-600">\${Math.round(data.metrics.queue_depth)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ì˜¤ë¥˜ìœ¨:</span>
                                        <span class="font-bold text-red-600">\${Math.round(data.metrics.error_rate)}%</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-semibold mb-2">ğŸ“ ìµœê·¼ ì—ëŸ¬ ë¡œê·¸</h4>
                                <div class="bg-gray-900 text-red-400 p-3 rounded text-xs font-mono max-h-32 overflow-y-auto">
                                    \${data.logs.map(log => \`<div>\${log}</div>\`).join('')}
                                </div>
                            </div>
                        </div>
                    \`;
                    
                    currentIncident = { nodeId: nodeId, suggestions: data.suggestions };
                    document.getElementById('popup').classList.remove('hidden');
                    document.getElementById('popup-overlay').classList.remove('hidden');
                } catch (error) {
                    console.error('Error loading node details:', error);
                }
            }

            function closePopup() {
                document.getElementById('popup').classList.add('hidden');
                document.getElementById('popup-overlay').classList.add('hidden');
            }

            async function remediate() {
                if (!currentIncident || !currentIncident.suggestions || currentIncident.suggestions.length === 0) return;
                
                const suggestion = currentIncident.suggestions[0]; // Use first suggestion
                
                try {
                    const response = await fetch('/api/remediation/apply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            actionId: suggestion.id,
                            nodeId: currentIncident.nodeId 
                        })
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        closePopup();
                        alert('âœ… ' + result.message + '\\n\\nì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        
                        // Complete final approval step
                        completeStep(4);
                        
                        // Update current issues
                        setTimeout(() => {
                            document.getElementById('current-issues').innerHTML = \`
                                <div class="bg-green-50 border border-green-200 p-4 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-check-circle text-green-600 mr-3"></i>
                                        <div>
                                            <h4 class="font-semibold text-green-800">ëª¨ë“  ë¬¸ì œê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤</h4>
                                            <p class="text-sm text-green-600 mt-1">ì‹œìŠ¤í…œì´ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                                        </div>
                                    </div>
                                </div>
                            \`;
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error applying remediation:', error);
                }
            }

            async function applyRecommendation(actionId) {
                if (confirm('ì„ íƒí•œ ì¡°ì¹˜ì‚¬í•­ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    try {
                        const response = await fetch('/api/remediation/apply', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ actionId: actionId })
                        });
                        const result = await response.json();
                        
                        if (result.success) {
                            alert('âœ… ' + result.message);
                            completeStep(4);
                        }
                    } catch (error) {
                        console.error('Error applying recommendation:', error);
                    }
                }
            }

            async function resetSystem() {
                if (confirm('ì‹œìŠ¤í…œì„ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    try {
                        const response = await fetch('/api/scenario/stop', { method: 'POST' });
                        const result = await response.json();
                        
                        if (result.success) {
                            alert('âœ… ì‹œìŠ¤í…œì´ ì •ìƒ ìƒíƒœë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 1000);
                        }
                    } catch (error) {
                        console.error('Error resetting system:', error);
                    }
                }
            }

            // Clean up on page unload
            window.addEventListener('beforeunload', function() {
                if (eventSource) {
                    eventSource.close();
                }
            });
        </script>
    </body>
    </html>
  `)
})

export default app
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          .topology-container {
            width: 100%;
            height: 500px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            position: relative;
            background: linear-gradient(45deg, #f8fafc 25%, transparent 25%), 
                        linear-gradient(-45deg, #f8fafc 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #f8fafc 75%), 
                        linear-gradient(-45deg, transparent 75%, #f8fafc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
          }
          .node {
            position: absolute;
            width: 80px;
            height: 60px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          .node:hover {
            transform: scale(1.1);
            z-index: 10;
          }
          .node.GREEN { background: #10b981; color: white; }
          .node.YELLOW { background: #f59e0b; color: white; }
          .node.RED { background: #ef4444; color: white; }
          .edge {
            position: absolute;
            height: 2px;
            background: #6b7280;
            transform-origin: left center;
          }
          .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
          }
          .drilldown-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            transition: right 0.3s;
            z-index: 100;
          }
          .drilldown-panel.open {
            right: 0;
          }
        </style>
    </head>
    <body class="bg-gray-50 p-4">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-chart-line mr-2"></i>
                        ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ
                    </h1>
                    <div class="flex gap-2">
                        <button onclick="startScenario(1)" 
                                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            ì‹œë‚˜ë¦¬ì˜¤ 1 ì‹œì‘ (ëŒ€ëŸ‰ì¡°íšŒ)
                        </button>
                        <button onclick="startScenario(2)" 
                                class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                            ì‹œë‚˜ë¦¬ì˜¤ 2 ì‹œì‘ (ë§ˆìŠ¤í„°ë¶ˆì¼ì¹˜)
                        </button>
                        <button onclick="stopScenario()" 
                                class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            ë³µêµ¬
                        </button>
                    </div>
                </div>
            </div>

            <!-- System Topology -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ì‹œìŠ¤í…œ ì„¤ê³„ë„</h2>
                <div id="topology" class="topology-container">
                    <!-- Nodes and edges will be rendered here -->
                </div>
            </div>

            <!-- Metrics Summary -->
            <div id="metrics-summary" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Metrics cards will be rendered here -->
            </div>
        </div>

        <!-- Popup Modal -->
        <div id="popup" class="popup hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-md">
                <div class="flex items-center mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl mr-3"></i>
                    <h3 class="text-lg font-semibold">ì‹œìŠ¤í…œ ì•Œë¦¼</h3>
                </div>
                <p id="popup-message" class="text-gray-700 mb-4"></p>
                <div class="flex justify-end gap-2">
                    <button onclick="closePopup()" 
                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400">
                        ì·¨ì†Œ
                    </button>
                    <button id="remediate-btn" onclick="remediate()" 
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        ë³´ìˆ˜
                    </button>
                </div>
            </div>
        </div>

        <!-- Drilldown Panel -->
        <div id="drilldown-panel" class="drilldown-panel">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">ìƒì„¸ ì •ë³´</h3>
                    <button onclick="closeDrilldown()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="drilldown-content">
                    <!-- Drilldown content will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Popup Overlay -->
        <div id="popup-overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closePopup()"></div>

        <script>
            let currentScenario = null;
            let currentIncident = null;
            let eventSource = null;

            // Initialize
            document.addEventListener('DOMContentLoaded', function() {
                loadTopology();
                loadStatus();
                startEventStream();
            });

            function startEventStream() {
                if (eventSource) {
                    eventSource.close();
                }
                
                eventSource = new EventSource('/api/events');
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateTopology(data.status);
                    updateMetrics(data.status, data.metrics);
                    
                    // Show popup for new incidents
                    if (data.incidents && data.incidents.length > 0) {
                        const incident = data.incidents[0];
                        if (!currentIncident || currentIncident.id !== incident.id) {
                            currentIncident = incident;
                            showPopup(incident);
                        }
                    }
                };
            }

            async function loadTopology() {
                try {
                    const response = await fetch('/api/topology');
                    const data = await response.json();
                    renderTopology(data);
                } catch (error) {
                    console.error('Error loading topology:', error);
                }
            }

            async function loadStatus() {
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    updateMetrics(null, data);
                } catch (error) {
                    console.error('Error loading status:', error);
                }
            }

            function renderTopology(data) {
                const container = document.getElementById('topology');
                container.innerHTML = '';

                // Render edges first (so they appear behind nodes)
                data.edges.forEach(edge => {
                    const fromNode = data.nodes.find(n => n.id === edge.from);
                    const toNode = data.nodes.find(n => n.id === edge.to);
                    
                    if (fromNode && toNode) {
                        const edgeElement = document.createElement('div');
                        edgeElement.className = 'edge';
                        
                        const deltaX = toNode.x - fromNode.x;
                        const deltaY = toNode.y - fromNode.y;
                        const length = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                        const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
                        
                        edgeElement.style.width = length + 'px';
                        edgeElement.style.left = (fromNode.x + 40) + 'px';
                        edgeElement.style.top = (fromNode.y + 30) + 'px';
                        edgeElement.style.transform = \`rotate(\${angle}deg)\`;
                        
                        container.appendChild(edgeElement);
                    }
                });

                // Render nodes
                data.nodes.forEach(node => {
                    const nodeElement = document.createElement('div');
                    nodeElement.className = \`node \${node.status}\`;
                    nodeElement.style.left = node.x + 'px';
                    nodeElement.style.top = node.y + 'px';
                    nodeElement.onclick = () => showDrilldown(node.id);
                    
                    nodeElement.innerHTML = \`
                        <i class="fas fa-server text-sm"></i>
                        <span class="text-xs font-semibold mt-1">\${node.name}</span>
                    \`;
                    
                    container.appendChild(nodeElement);
                });
            }

            function updateTopology(nodes) {
                const container = document.getElementById('topology');
                const nodeElements = container.querySelectorAll('.node');
                
                nodeElements.forEach((element, index) => {
                    const nodeId = Object.keys(nodes)[index];
                    if (nodeId && nodes[nodeId]) {
                        element.className = \`node \${nodes[nodeId].status}\`;
                    }
                });
            }

            function updateMetrics(nodes, data) {
                const container = document.getElementById('metrics-summary');
                container.innerHTML = '';

                Object.entries(data).forEach(([nodeId, info]) => {
                    const metrics = info.metrics || info;
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow p-4';
                    
                    card.innerHTML = \`
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-gray-700">\${nodeId.toUpperCase()}</h3>
                            <span class="px-2 py-1 rounded text-xs font-medium \${
                                info.health === 'GREEN' ? 'bg-green-100 text-green-800' :
                                info.health === 'YELLOW' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                            }">
                                \${info.health || 'GREEN'}
                            </span>
                        </div>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>CPU:</span>
                                <span>\${Math.round(metrics.cpu)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span>ì‘ë‹µì‹œê°„:</span>
                                <span>\${Math.round(metrics.response_time)}ms</span>
                            </div>
                            <div class="flex justify-between">
                                <span>í ê¹Šì´:</span>
                                <span>\${Math.round(metrics.queue_depth)}</span>
                            </div>
                        </div>
                    \`;
                    
                    container.appendChild(card);
                });
            }

            async function startScenario(scenario) {
                try {
                    const response = await fetch(\`/api/scenario/start?s=\${scenario}\`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    currentScenario = scenario;
                    console.log(\`ì‹œë‚˜ë¦¬ì˜¤ \${scenario} ì‹œì‘:\`, result.message);
                } catch (error) {
                    console.error('Error starting scenario:', error);
                }
            }

            async function stopScenario() {
                try {
                    const response = await fetch('/api/scenario/stop', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    currentScenario = null;
                    currentIncident = null;
                    closePopup();
                    console.log('ì‹œë‚˜ë¦¬ì˜¤ ì •ì§€:', result.message);
                } catch (error) {
                    console.error('Error stopping scenario:', error);
                }
            }

            function showPopup(incident) {
                document.getElementById('popup-message').textContent = incident.title;
                document.getElementById('popup').classList.remove('hidden');
                document.getElementById('popup-overlay').classList.remove('hidden');
            }

            function closePopup() {
                document.getElementById('popup').classList.add('hidden');
                document.getElementById('popup-overlay').classList.add('hidden');
            }

            async function remediate() {
                if (!currentIncident || !currentScenario) return;
                
                let actionId;
                if (currentScenario === 1) {
                    actionId = 'ENABLE_QUERY_GOVERNOR';
                } else if (currentScenario === 2) {
                    actionId = 'SYNC_MASTER_DATA';
                }

                try {
                    const response = await fetch('/api/remediation/apply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            actionId: actionId,
                            nodeId: currentIncident.nodeId 
                        })
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        closePopup();
                        currentIncident = null;
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('Error applying remediation:', error);
                }
            }

            async function showDrilldown(nodeId) {
                try {
                    const response = await fetch(\`/api/node/\${nodeId}/drilldown\`);
                    const data = await response.json();
                    
                    const content = document.getElementById('drilldown-content');
                    content.innerHTML = \`
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-semibold mb-2">ë…¸ë“œ ì •ë³´</h4>
                                <p class="text-sm text-gray-600">\${data.node.name} (\${data.node.type})</p>
                                <p class="text-sm \${
                                    data.node.status === 'GREEN' ? 'text-green-600' :
                                    data.node.status === 'YELLOW' ? 'text-yellow-600' :
                                    'text-red-600'
                                }">\${data.node.status}</p>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold mb-2">ì›ì¸ ë¶„ì„</h4>
                                <p class="text-sm text-gray-700">\${data.rootCause}</p>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold mb-2">ìµœê·¼ ë¡œê·¸</h4>
                                <div class="bg-gray-900 text-green-400 p-3 rounded text-xs font-mono max-h-40 overflow-y-auto">
                                    \${data.logs.map(log => \`<div>\${log}</div>\`).join('')}
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-semibold mb-2">ë©”íŠ¸ë¦­</h4>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div>CPU: \${Math.round(data.metrics.cpu)}%</div>
                                    <div>ë©”ëª¨ë¦¬: \${Math.round(data.metrics.memory)}%</div>
                                    <div>ì‘ë‹µì‹œê°„: \${Math.round(data.metrics.response_time)}ms</div>
                                    <div>í ê¹Šì´: \${Math.round(data.metrics.queue_depth)}</div>
                                </div>
                            </div>
                            
                            \${data.suggestions.length > 0 ? \`
                                <div>
                                    <h4 class="font-semibold mb-2">ìˆ˜ë¦¬ ë°©ì•ˆ</h4>
                                    <div class="space-y-2">
                                        \${data.suggestions.map(suggestion => \`
                                            <button onclick="applyRemediation('\${suggestion.id}', '\${nodeId}')" 
                                                    class="w-full text-left bg-blue-50 hover:bg-blue-100 p-3 rounded border">
                                                <div class="font-medium text-blue-900">\${suggestion.label}</div>
                                                <div class="text-sm text-blue-700">\${suggestion.description}</div>
                                            </button>
                                        \`).join('')}
                                    </div>
                                </div>
                            \` : ''}
                        </div>
                    \`;
                    
                    document.getElementById('drilldown-panel').classList.add('open');
                } catch (error) {
                    console.error('Error loading drilldown:', error);
                }
            }

            function closeDrilldown() {
                document.getElementById('drilldown-panel').classList.remove('open');
            }

            async function applyRemediation(actionId, nodeId) {
                try {
                    const response = await fetch('/api/remediation/apply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ actionId, nodeId })
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(result.message);
                        closeDrilldown();
                    }
                } catch (error) {
                    console.error('Error applying remediation:', error);
                }
            }

            // Clean up on page unload
            window.addEventListener('beforeunload', function() {
                if (eventSource) {
                    eventSource.close();
                }
            });
        </script>
    </body>
    </html>
  `)
})

export default app
